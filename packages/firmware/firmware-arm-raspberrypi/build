#!/bin/sh

. config/options

cd $BUILD/$1*

# copy license files
mkdir -p .install/boot
cp -P -r boot/*.elf boot/*.dat boot/bootcode.bin boot/LICENCE.* .install/boot/

# set distro name
echo "$DISTRONAME $TARGET_ARCH $DISTRO_VERSION $DISTRO_COPYRIGHT" \
  > .install/boot/issue.txt


CMDLINE="dwc_otg.lpm_enable=0 root=/dev/mmcblk0p2 rootfstype=ext4 rw rootwait vt.global_cursor_default=0"
if [ "$RPI_USE_CMA" = yes ]; then
  CMDLINE="$CMDLINE coherent_pool=6M smsc95xx.turbo_mode=N"
else
  use_mem_split="# "
fi

if [ "$RPI_SDTV_COLORBURST" = yes ]; then
  no_colorburst=0
else
  no_colorburst=1
fi

if [ -n "$RPI_MPEG2_LICENSE" ]; then
  mpg2_license="decode_MPG2=$RPI_MPEG2_LICENSE"
else
  mpg2_license="# decode_MPG2=0x00000000"
fi

if [ -n "$RPI_VC1_LICENSE" ]; then
  vwc1_license="decode_WVC1=$RPI_VC1_LICENSE"
else
  vwc1_license="# decode_WVC1=0x00000000"
fi


# create 'cmdline.txt'
echo "$CMDLINE" > .install/boot/cmdline.txt

# create 'config.txt'
cat > .install/boot/config.txt <<EOF
sdtv_mode=$RPI_SDTV_MODE
sdtv_aspect=$RPI_SDTV_ASPECT
sdtv_disable_colourburst=$no_colorburst
 
# hdmi_ignore_cec_init=1
hdmi_force_hotplug=1
hdmi_group=2
hdmi_mode=1
hdmi_mode=87
hdmi_cvt=800 480 60 6 0 0 0
hdmi_drive=1
dtparam=spi=on
dtoverlay=spi-bcm2835-overlay
dtoverlay=mcp2515-can0-overlay,oscillator=16000000,interrupt=25 
dtoverlay=ads7846,penirq=24,speed=10000,penirq_pull=2,xohms=150
dtparam=i2c=on

${mpg2_license}
${vwc1_license}

${use_mem_split}gpu_mem_256=112
${use_mem_split}gpu_mem_512=320
${use_mem_split}gpu_mem_1024=384

EOF

mkdir -p .install/etc/udev/rules.d

# Create symlink touchscreen device
cat <<'EOF' >> .install/etc/udev/rules.d/29-ads7846.rules 
SUBSYSTEM=="input", KERNEL=="event[0-9]*", ATTRS{name}=="ADS7846 Touchscreen", SYMLINK+="input/touchscreen"
EOF
